<?php
// =========================================================================
// GTV News Manager â€” WPCode PHP Snippet v2.1
// Added: Sidebar settings tab
// =========================================================================


// 1. REGISTER POST TYPE
add_action( 'init', 'gtv_news_register_post_type' );
function gtv_news_register_post_type() {
    $labels = array(
        'name'          => 'News Stories',
        'singular_name' => 'News Story',
        'menu_name'     => 'News',
        'add_new'       => 'Add News Story',
        'edit_item'     => 'Edit News Story',
        'view_item'     => 'View Story',
        'search_items'  => 'Search News',
        'not_found'     => 'No stories found',
    );
    $args = array(
        'labels'       => $labels,
        'public'       => true,
        'show_in_rest' => true,
        'has_archive'  => true,
        'show_in_menu' => false,
        'menu_icon'    => 'dashicons-megaphone',
        'supports'     => array( 'title', 'editor', 'thumbnail', 'excerpt', 'author', 'custom-fields' ),
        'taxonomies'   => array( 'post_tag', 'category' ),
        'rewrite'      => array( 'slug' => 'gtvnews' ),
    );
    register_post_type( 'gtv_news', $args );
}


// 2. ADMIN MENU
add_action( 'admin_menu', 'gtv_news_admin_menu' );
function gtv_news_admin_menu() {
    add_menu_page( 'News Manager', 'News', 'edit_posts', 'gtv-news-manager', 'gtv_news_render_dashboard', 'dashicons-megaphone', 6 );
    add_submenu_page( 'gtv-news-manager', 'All Stories', 'All Stories', 'edit_posts', 'gtv-news-manager', 'gtv_news_render_dashboard' );
    add_submenu_page( 'gtv-news-manager', 'Add New Story', 'Add New', 'edit_posts', 'post-new.php?post_type=gtv_news' );
}


// 3. ADMIN STYLES
add_action( 'admin_enqueue_scripts', 'gtv_news_admin_styles' );
function gtv_news_admin_styles( $hook ) {
    if ( strpos( $hook, 'gtv-news-manager' ) === false ) return;
    $css = '
        .gtv-wrap { max-width:1200px; padding:20px 0; font-family:-apple-system,sans-serif; }
        .gtv-head { display:flex; justify-content:space-between; border-bottom:4px solid #4b286d; padding-bottom:15px; margin-bottom:25px; align-items:center; }
        .gtv-head h1 { margin:0; font-size:24px; font-weight:700; display:flex; align-items:center; gap:10px; }
        .gtv-btn-add { background:#00703c; color:white; padding:8px 16px; text-decoration:none; border-radius:4px; font-weight:bold; }
        .gtv-cards { display:grid; grid-template-columns:repeat(4,1fr); gap:20px; margin-bottom:30px; }
        .gtv-card { background:white; padding:20px; border-top:5px solid #ccc; box-shadow:0 2px 5px rgba(0,0,0,0.05); display:block; text-decoration:none; color:black; }
        .gtv-card:hover { transform:translateY(-3px); }
        .gtv-card span { display:block; }
        .gtv-num { font-size:32px; font-weight:bold; }
        .gtv-lbl { font-size:12px; font-weight:bold; text-transform:uppercase; color:#555; }
        .gtv-table { width:100%; border-collapse:collapse; background:white; border:1px solid #ccc; }
        .gtv-table th { background:#4b286d; color:white; padding:12px; text-align:left; }
        .gtv-table td { padding:12px; border-bottom:1px solid #eee; vertical-align:middle; }
        .gtv-act { margin-right:10px; text-decoration:none; font-weight:bold; font-size:13px; }
        /* Tabs */
        .gtv-tabs { display:flex; gap:0; margin-bottom:25px; border-bottom:3px solid #4b286d; }
        .gtv-tab { padding:10px 20px; text-decoration:none; font-weight:700; font-size:14px; color:#555; background:#f3f2f1; border:1px solid #ccc; border-bottom:none; margin-right:4px; }
        .gtv-tab:hover { color:#4b286d; }
        .gtv-tab--active { background:white; color:#4b286d; border-top:3px solid #4b286d; margin-top:-3px; padding-top:10px; }
        /* Sidebar settings */
        .gtv-settings-box { background:white; border:1px solid #ccc; padding:25px; margin-bottom:20px; }
        .gtv-settings-box h2 { margin-top:0; font-size:18px; border-bottom:2px solid #f0f0f0; padding-bottom:12px; margin-bottom:20px; color:#4b286d; }
        .gtv-field { margin-bottom:20px; }
        .gtv-field label { display:block; font-weight:700; margin-bottom:6px; font-size:14px; }
        .gtv-field select, .gtv-field input[type="number"] { padding:8px 10px; border:1px solid #ccc; font-size:14px; min-width:200px; }
        .gtv-field textarea { width:100%; min-height:150px; padding:10px; border:1px solid #ccc; font-size:14px; font-family:inherit; }
        .gtv-field .gtv-hint { font-size:12px; color:#666; margin-top:4px; display:block; }
        .gtv-save-btn { background:#4b286d; color:white; border:none; padding:10px 24px; font-size:14px; font-weight:700; cursor:pointer; border-radius:4px; }
        .gtv-save-btn:hover { background:#3a1e56; }
        .gtv-notice-success { background:#d1fae5; border-left:4px solid #00703c; padding:12px 16px; margin-bottom:20px; font-weight:700; }
        .gtv-toggle { display:flex; align-items:center; gap:10px; }
        .gtv-toggle input[type="checkbox"] { width:18px; height:18px; }
    ';
    wp_add_inline_style( 'wp-admin', $css );
}


// 4. DASHBOARD ROUTER
function gtv_news_render_dashboard() {
    $tab = isset( $_GET['tab'] ) ? sanitize_text_field( $_GET['tab'] ) : 'stories';

    // Tab navigation
    $tabs = [
        'stories'  => 'All Stories',
        'sidebar'  => 'Sidebar Settings',
    ];

    echo '<div class="gtv-wrap">';
    echo '<div class="gtv-head"><h1>ðŸ“° News Manager</h1>';
    if ( $tab === 'stories' ) {
        echo '<a href="' . esc_url( admin_url( 'post-new.php?post_type=gtv_news' ) ) . '" class="gtv-btn-add">Add New Story</a>';
    }
    echo '</div>';

    echo '<div class="gtv-tabs">';
    foreach ( $tabs as $key => $label ) {
        $active = $tab === $key ? ' gtv-tab--active' : '';
        echo '<a href="?page=gtv-news-manager&tab=' . esc_attr( $key ) . '" class="gtv-tab' . $active . '">' . esc_html( $label ) . '</a>';
    }
    echo '</div>';

    if ( $tab === 'stories' ) {
        gtv_news_render_stories_tab();
    } elseif ( $tab === 'sidebar' ) {
        gtv_news_render_sidebar_tab();
    }

    echo '</div>';
}


// 5. STORIES TAB
function gtv_news_render_stories_tab() {

    if (
        isset( $_GET['gtv_delete'] ) &&
        isset( $_GET['_wpnonce'] ) &&
        current_user_can( 'delete_posts' ) &&
        wp_verify_nonce( $_GET['_wpnonce'], 'gtv_delete_' . intval( $_GET['gtv_delete'] ) )
    ) {
        wp_trash_post( intval( $_GET['gtv_delete'] ) );
        echo '<div class="gtv-notice-success">Story moved to trash.</div>';
    }

    $status = isset( $_GET['status'] ) ? sanitize_text_field( $_GET['status'] ) : '';
    $paged  = isset( $_GET['paged'] )  ? max( 1, intval( $_GET['paged'] ) )      : 1;

    $query = new WP_Query( array(
        'post_type'      => 'gtv_news',
        'post_status'    => $status ? array( $status ) : array( 'publish', 'draft', 'pending' ),
        'posts_per_page' => 20,
        'paged'          => $paged,
    ) );

    $c     = wp_count_posts( 'gtv_news' );
    $pub   = absint( $c->publish );
    $draft = absint( $c->draft );
    $pend  = absint( $c->pending );
    $all   = $pub + $draft + $pend;

    echo '<div class="gtv-cards">';
    echo '<a href="?page=gtv-news-manager&tab=stories&status=publish" class="gtv-card" style="border-color:#00703c"><span class="gtv-num">' . $pub . '</span><span class="gtv-lbl">Published</span></a>';
    echo '<a href="?page=gtv-news-manager&tab=stories&status=draft"   class="gtv-card" style="border-color:#ffdd00"><span class="gtv-num">' . $draft . '</span><span class="gtv-lbl">Drafts</span></a>';
    echo '<a href="?page=gtv-news-manager&tab=stories&status=pending" class="gtv-card" style="border-color:#1d70b8"><span class="gtv-num">' . $pend . '</span><span class="gtv-lbl">Pending</span></a>';
    echo '<a href="?page=gtv-news-manager&tab=stories"                class="gtv-card" style="border-color:#4b286d"><span class="gtv-num">' . $all . '</span><span class="gtv-lbl">All Stories</span></a>';
    echo '</div>';

    echo '<table class="gtv-table">';
    echo '<thead><tr><th>Title</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead>';
    echo '<tbody>';

    if ( $query->have_posts() ) {
        while ( $query->have_posts() ) {
            $query->the_post();
            $pid      = get_the_ID();
            $st       = get_post_status();
            $edit_url = esc_url( get_edit_post_link( $pid ) );
            $del_url  = esc_url( wp_nonce_url( admin_url( 'admin.php?page=gtv-news-manager&tab=stories&gtv_delete=' . $pid ), 'gtv_delete_' . $pid ) );

            echo '<tr>';
            echo '<td><strong>' . esc_html( get_the_title() ) . '</strong></td>';
            echo '<td>' . esc_html( get_the_date( 'd/m/Y' ) ) . '</td>';
            echo '<td>' . esc_html( ucfirst( $st ) ) . '</td>';
            echo '<td>';
            echo '<a href="' . $edit_url . '" class="gtv-act" style="color:#1d70b8">Edit</a>';
            if ( $st === 'publish' ) {
                echo '<a href="' . esc_url( get_permalink( $pid ) ) . '" class="gtv-act" style="color:#00703c" target="_blank" rel="noopener">View</a>';
            }
            echo '<a href="' . $del_url . '" class="gtv-act" style="color:#d4351c" onclick="return confirm(\'Move this story to trash?\');">Trash</a>';
            echo '</td>';
            echo '</tr>';
        }
        wp_reset_postdata();
    } else {
        echo '<tr><td colspan="4" style="padding:20px;">No stories found.</td></tr>';
    }

    echo '</tbody></table>';

    if ( $query->max_num_pages > 1 ) {
        echo '<div style="margin-top:20px;">';
        echo paginate_links( array( 'total' => $query->max_num_pages, 'current' => $paged ) );
        echo '</div>';
    }
}


// 6. SIDEBAR SETTINGS TAB
function gtv_news_render_sidebar_tab() {

    // Save
    if ( isset( $_POST['gtv_sidebar_save'] ) && check_admin_referer( 'gtv_sidebar_save', 'gtv_sidebar_nonce' ) ) {
        update_option( 'gtv_news_sidebar_enabled', isset( $_POST['sidebar_enabled'] ) ? 1 : 0 );
        update_option( 'gtv_news_sidebar_type',    sanitize_text_field( $_POST['sidebar_type'] ) );
        update_option( 'gtv_news_sidebar_count',   absint( $_POST['sidebar_count'] ) );
        update_option( 'gtv_news_sidebar_custom',  wp_kses_post( $_POST['sidebar_custom'] ) );
        echo '<div class="gtv-notice-success">âœ“ Sidebar settings saved.</div>';
    }

    // Current values
    $enabled = get_option( 'gtv_news_sidebar_enabled', 1 );
    $type    = get_option( 'gtv_news_sidebar_type',    'latest' );
    $count   = get_option( 'gtv_news_sidebar_count',   3 );
    $custom  = get_option( 'gtv_news_sidebar_custom',  '' );

    ?>
    <form method="post">
        <?php wp_nonce_field( 'gtv_sidebar_save', 'gtv_sidebar_nonce' ); ?>

        <div class="gtv-settings-box">
            <h2>Sidebar Settings</h2>
            <p style="color:#555; margin-top:-10px; margin-bottom:20px;">Controls the sidebar displayed on all single news story pages.</p>

            <div class="gtv-field">
                <div class="gtv-toggle">
                    <input type="checkbox" id="sidebar_enabled" name="sidebar_enabled" value="1" <?php checked( $enabled, 1 ); ?>>
                    <label for="sidebar_enabled" style="margin:0; font-weight:700;">Enable sidebar on single news posts</label>
                </div>
            </div>

            <div class="gtv-field">
                <label for="sidebar_type">Sidebar content type</label>
                <select name="sidebar_type" id="sidebar_type">
                    <option value="latest"  <?php selected( $type, 'latest'  ); ?>>Latest news stories</option>
                    <option value="related" <?php selected( $type, 'related' ); ?>>Related stories (by tags)</option>
                    <option value="both"    <?php selected( $type, 'both'    ); ?>>Both â€” latest + related</option>
                </select>
                <span class="gtv-hint">Related stories are matched by shared tags. Falls back to latest if no tag matches found.</span>
            </div>

            <div class="gtv-field">
                <label for="sidebar_count">Number of stories to show</label>
                <select name="sidebar_count" id="sidebar_count">
                    <option value="2" <?php selected( $count, 2 ); ?>>2 stories</option>
                    <option value="3" <?php selected( $count, 3 ); ?>>3 stories</option>
                    <option value="4" <?php selected( $count, 4 ); ?>>4 stories</option>
                </select>
                <span class="gtv-hint">When "Both" is selected, this number applies to each section separately.</span>
            </div>

            <div class="gtv-field">
                <label for="sidebar_custom">Custom content block <span style="font-weight:400;">(optional)</span></label>
                <textarea name="sidebar_custom" id="sidebar_custom"><?php echo esc_textarea( $custom ); ?></textarea>
                <span class="gtv-hint">HTML allowed. Displayed below the story cards. Use for calls to action, links, or any additional content.</span>
            </div>

            <button type="submit" name="gtv_sidebar_save" class="gtv-save-btn">Save Sidebar Settings</button>
        </div>

        <div class="gtv-settings-box" style="background:#f9f9fa;">
            <h2>Preview</h2>
            <p style="color:#555; margin-top:-10px;">Current configuration: 
                <strong><?php echo $enabled ? 'Sidebar ON' : 'Sidebar OFF'; ?></strong> &mdash;
                <?php
                $type_labels = [ 'latest' => 'Latest news', 'related' => 'Related stories', 'both' => 'Latest + Related' ];
                echo esc_html( $type_labels[ $type ] ?? $type );
                ?>,
                <strong><?php echo esc_html( $count ); ?> stories</strong>
                <?php echo ! empty( $custom ) ? ', custom block enabled' : ''; ?>
            </p>
            <p style="font-size:13px; color:#888;">Changes are live immediately after saving â€” visit any news story to see the updated sidebar.</p>
        </div>

    </form>
    <?php
}


// 7. REDIRECT ATTACHMENT PAGES TO PARENT POST
add_action( 'template_redirect', 'gtv_redirect_attachment_pages' );
function gtv_redirect_attachment_pages() {
    if ( is_attachment() ) {
        $parent = wp_get_post_parent_id( get_the_ID() );
        if ( $parent ) {
            wp_redirect( get_permalink( $parent ), 301 );
        } else {
            wp_redirect( home_url(), 301 );
        }
        exit;
    }
}


// 8. REMOVE DUPLICATE FEATURED IMAGE FROM POST BODY
add_filter( 'the_content', 'gtv_remove_duplicate_featured_image' );
function gtv_remove_duplicate_featured_image( $content ) {
    if ( ! is_singular( 'gtv_news' ) ) return $content;

    $thumb_id = get_post_thumbnail_id();
    if ( ! $thumb_id ) return $content;

    $thumb_url = get_the_post_thumbnail_url( get_the_ID(), 'full' );
    if ( ! $thumb_url ) return $content;

    $thumb_base = preg_replace( '/-\d+x\d+(\.\w+)$/', '$1', basename( $thumb_url ) );
    $content    = preg_replace( '/<img[^>]+src=["\'][^"\']*' . preg_quote( $thumb_base, '/' ) . '[^"\']*["\'][^>]*>/i', '', $content );
    $content    = preg_replace( '/<figure[^>]*>\s*<\/figure>/i', '', $content );
    $content    = preg_replace( '/<p>\s*<\/p>/i', '', $content );

    return $content;
}


// 9. EDIT STORY BUTTON IN ADMIN BAR
add_action( 'admin_bar_menu', 'gtv_news_admin_bar_edit', 999 );
function gtv_news_admin_bar_edit( $wp_admin_bar ) {
    if ( ! is_singular( 'gtv_news' ) || ! current_user_can( 'edit_posts' ) ) return;
    $wp_admin_bar->add_node( array(
        'id'    => 'gtv-edit-story',
        'title' => '&#9998; Edit Story',
        'href'  => get_edit_post_link( get_the_ID() ),
        'meta'  => array( 'title' => 'Edit this news story' ),
    ) );
}
